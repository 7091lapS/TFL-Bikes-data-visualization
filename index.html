<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Boris Bikes Visualization</title>
    <script type="text/javascript" src="d3/d3.min.js"></script>
    <script src="http://d3js.org/topojson.v0.min.js"></script>
    <script type="text/javascript" src="secret.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css">
  </head>
  <body>
    <script type="text/javascript">
      var w = 800;
      var h = 500;
      var svg = d3.select("body")
        .append("svg")
        .attr("viewBox", "0 0 " + w + " " + h )
        .attr("preserveAspectRatio", "xMidYMid meet");
      var projection = d3.geo.mercator()
        .translate([540, h/2])
        .center([0.0, 51.4979])
        .scale(180000);
      var path = d3.geo.path()
        .projection(projection);
      var landuse = svg.append("g");
      var roads = svg.append("g");
      var roads_residential = svg.append("g");
      var roads_primary = svg.append("g");
      var roads_trunk = svg.append("g");
      var water = svg.append("g");
      var dockSize = svg.append('g');
      var bikesLeft = svg.append('g');
      var bikesUsed = function(data) {
        var bikes = 0
        for(var i = 0; i < data.length; i++) {
          bikes += parseInt(data[i].additionalProperties[7].value);
        }
        return bikes;
      }

      d3.json('london.topo.json', function(data) {

        landuse.append("path")
          .datum(topojson.object(data, data.objects.landuse))
          .attr("class", "landuse")
          .attr("d", path);

        roads.append("path")
          .datum(topojson.object(data, data.objects.roads))
          .attr("class", "roads")
          .attr("d", path);

        roads_residential.append("path")
          .datum(topojson.object(data, data.objects.roads_residential))
          .attr("class", "roads_residential")
          .attr("d", path);

        roads_primary.append("path")
          .datum(topojson.object(data, data.objects.roads_primary))
          .attr("class", "roads_primary")
          .attr("d", path);

        roads_trunk.append("path")
          .datum(topojson.object(data, data.objects.roads_trunk))
          .attr("class", "roads_trunk")
          .attr("d", path);

        water.append("path")
          .datum(topojson.object(data, data.objects.waterway))
          .attr("class", "water")
          .attr("d", path);
      });

      d3.json("https://api.tfl.gov.uk/BikePoint?app_id=" + appId + "&app_key=" + appKey, function(data){

        svg.append('text')
          .attr('class', 'textData')
          .data(data)
          .attr("x", w - w/4)
          .attr("y", 300)
          .append('svg:tspan')
          .attr('x', w - w/4 )
          .attr('dy', 5)
          .text(bikesUsed(data) + " bikes used")
          .append('svg:tspan')
          .attr('x', w - w/4)
          .attr('dy', 20)
          .text(data.length + " bike points")

        dockSize.selectAll("circle")
          .data(data)
          .enter()
          .append("circle")
          .attr("r", 0)
          .style("fill-opacity", 0)
          .transition()
          .duration(2000)
          .attr("cx", function(d) {
            return projection([d.lon, d.lat])[0];
          })
          .attr("cy", function(d) {
            return projection([d.lon, d.lat])[1];
          })
          .attr("r", function(d) {
            return Math.cbrt(2 * d.additionalProperties[8].value);
          })
          .style("fill", "green")
          .style("fill-opacity", 0.8);

        bikesLeft.selectAll("circle")
          .data(data)
          .enter()
          .append("circle")
          .attr("r", 0)
          .style("fill-opacity", 0)
          .transition()
          .delay(500)
          .duration(2000)
          .attr("cx", function(d) {
            return projection([d.lon, d.lat])[0];
          })
          .attr("cy", function(d) {
            return projection([d.lon, d.lat])[1];
          })
          .attr("r", function(d) {
            return Math.cbrt(2 * d.additionalProperties[6].value);
          })
          .style("fill", "yellow")
          .style("fill-opacity", 0.5);
      });

      setInterval(function() {console.log("update!"); d3.json("https://api.tfl.gov.uk/BikePoint?app_id=" + appId + "&app_key=" + appKey, function(data) {
          bikesLeft.selectAll("circle")
            .data(data)
            .transition()
            .duration(2500)
            .attr("r", function(d) {
              return Math.cbrt(2 * d.additionalProperties[6].value);
            });
        })
      }, 306000);


    </script>
  </body>
</html>
